blueprint:
  name: Lux Motion Lights
  description: Turn on lights when motion and Lux is below a certain amount.
  domain: automation
  author: Dan Clayton

  input:
    light_target:
      name: Lights
      selector:
        target:
          domain:
            - light
            - switch
    motion_entity:
      name: Motion Sensor
      selector:
        entity:
          domain:
            - binary_sensor
          device_class: motion
    duration:
      name: Motion Duration
      selector:
        duration:
      default:
        hours: 0
        minutes: 20
        seconds: 0
    starttime:
      name: Motion Start time
      selector:
        time:
      default: "06:00:00"
    endtime:
      name: Motion End time
      selector:
        time:
      default: "21:30:00"
    brightness:
      name: Maximum brightness
      description: Brightness trigger level. If it gets any brighter the lights will not be turned on.
      default: 20000
      selector:
        number:
          min: 0
          max: 80000
          unit_of_measurement: lux

trigger:
  - platform: state
    entity_id:
      - !input motion_entity
    to: "on"

# making the input variable usable in the condition
variables:
  lights: !input "light_target"

condition:
  # - condition: or
  #   conditions:
  #   - "{{ expand(lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0 }}" # some lights in the group are on
  - condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.home_solar_rad_lx
        below: !input brightness
      - condition: time
        after: !input starttime
        before: !input endtime

action:
  - service: light.turn_on
    metadata: {}
    data: {}
    target: !input light_target
  - service: switch.turn_on
    metadata: {}
    data: {}
    target: !input light_target
  - wait_for_trigger:
      - platform: state
        entity_id:
          - !input motion_entity
        from: "on"
        for: !input duration
      - platform: numeric_state
        entity_id:
          - sensor.home_solar_rad_lx
        above: !input brightness
        for:
          minutes: 5
      - platform: template
        value_template: >-
          {{ expand(lights.entity_id) | selectattr('state', '==', 'on') | list |
          count == 0 }}
  - service: light.turn_off
    metadata: {}
    data: {}
    target: !input light_target
mode: single
